{"version":3,"sources":["../../src/pages/refeicao-list/refeicao-list.module.ts","../../src/pages/refeicao-list/refeicao-list.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AAAyC;AACO;AACG;AAEI;AAcvD,IAAa,kBAAkB,GAA/B;CAAkC;AAArB,kBAAkB;IAZ9B,uEAAQ,CAAC;QACR,YAAY,EAAE;YACZ,wEAAgB;SACjB;QACD,OAAO,EAAE;YACP,sEAAe,CAAC,QAAQ,CAAC,wEAAgB,CAAC;YAC1C,wEAAW;SACZ;QACD,OAAO,EAAE;YACP,wEAAgB;SACjB;KACF,CAAC;GACW,kBAAkB,CAAG;AAAH;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AClBW;AAC4D;AAE1C;AAI5D,2CAA2C;AACV;AACJ;AAE8B;AACQ;AACR;AAEnB;AAQxC,IAAa,gBAAgB,GAA7B;IAUE,YAAmB,OAAsB,EAAS,SAAoB,EAC7D,WAA8B,EAAS,IAAyB,EAChE,IAAiB,EAAS,SAA0B,EACpD,KAAkB,EAAS,SAA0B,EACpD,GAAQ;QAJC,YAAO,GAAP,OAAO,CAAe;QAAS,cAAS,GAAT,SAAS,CAAW;QAC7D,gBAAW,GAAX,WAAW,CAAmB;QAAS,SAAI,GAAJ,IAAI,CAAqB;QAChE,SAAI,GAAJ,IAAI,CAAa;QAAS,cAAS,GAAT,SAAS,CAAiB;QACpD,UAAK,GAAL,KAAK,CAAa;QAAS,cAAS,GAAT,SAAS,CAAiB;QACpD,QAAG,GAAH,GAAG,CAAK;QAVlB,cAAS,GAAY,KAAK,CAAC;QAC3B,WAAM,GAAmB,EAAE,CAAC;QAC5B,aAAQ,GAAmB,EAAE,CAAC;QAC9B,YAAO,GAAkB,EAAE,CAAC;QAC5B,mBAAc,GAAmB,EAAE,CAAC;QAQlC,kEAAkE;QAClE,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;IACtB,CAAC;IAED;;;OAGG;IACH,WAAW,CAAC,QAAa;QACvB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,oBAAoB,EAAE;YACtC,QAAQ,EAAE,QAAQ;SACnB,CAAC;IACJ,CAAC;IAED;;OAEG;IACH,WAAW,CAAC,QAAa;QACvB,IAAI,OAAO,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC;YAClC,KAAK,EAAE,mBAAmB;YAC1B,OAAO,EAAE,iDAAiD,oCAAM,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,4BAA4B;YAC5H,OAAO,EAAE;gBACP;oBACE,IAAI,EAAE,UAAU;iBACjB;gBACD;oBACE,IAAI,EAAE,KAAK;oBACX,OAAO,EAAE,GAAG,EAAE;wBACZ,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;oBACtB,CAAC;iBACF;aACF;SACF,CAAC,CAAC;QACH,OAAO,CAAC,OAAO,EAAE,CAAC;IACpB,CAAC;IAED,IAAI,CAAC,QAAa;QAChB,IAAI,CAAC,KAAK,CAAC,KAAK,EAAE;aACf,IAAI,CAAC,QAAQ,CAAC,EAAE;YACf,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,QAAQ,EAAE,QAAQ,CAAC,GAAG,EAAE,CAAC;iBAC1C,IAAI,CAAC,CAAC,CAAC,EAAE;gBACR,6CAA6C;gBAC7C,IAAI,CAAC,GAAG,CAAC,gBAAgB,CAAC,QAAQ,CAAC,SAAS,CAAC;gBAC7C,kCAAkC;gBAClC,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,QAAQ,EAAE,mBAAmB,oCAAM,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;gBAC7F,kCAAkC;gBAClC,4BAA4B;gBAC5B,IAAI,KAAK,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC;oBAChC,KAAK,EAAE,SAAS;oBAChB,QAAQ,EAAE,+BAA+B;oBACzC,OAAO,EAAE,CAAC;4BACR,IAAI,EAAE,IAAI;4BACV,OAAO,EAAE,CAAC,CAAC,EAAE;gCACX,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC,CAAC,wCAAwC;4BAC5E,CAAC;yBACF,CAAC;iBACH,CAAC,CAAC;gBACH,KAAK,CAAC,OAAO,EAAE,CAAC;YAClB,CAAC,CAAC;iBACD,KAAK,CAAC,MAAM,CAAC,EAAE;gBACd,IAAI,KAAK,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC;oBAChC,KAAK,EAAE,MAAM;oBACb,QAAQ,EAAE,MAAM,CAAC,OAAO;oBACxB,OAAO,EAAE,CAAC,IAAI,CAAC;iBAChB,CAAC;gBACF,KAAK,CAAC,OAAO,EAAE,CAAC;YAClB,CAAC,CAAC,CAAC;QACP,CAAC,CAAC;IACN,CAAC;IAED;;OAEG;IACH,YAAY,CAAC,QAAa;QACxB,IAAI,OAAO,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC;YAClC,KAAK,EAAE,2BAA2B;YAClC,OAAO,EAAE,4DAA4D,oCAAM,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,qHAAqH;YAChO,OAAO,EAAE;gBACP;oBACE,IAAI,EAAE,UAAU;iBACjB;gBACD;oBACE,IAAI,EAAE,KAAK;oBACX,OAAO,EAAE,GAAG,EAAE;wBACZ,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC;oBACvB,CAAC;iBACF;aACF;SACF,CAAC,CAAC;QACH,OAAO,CAAC,OAAO,EAAE,CAAC;IACpB,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,QAAa;QACjB,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,QAAQ,CAAC;aAC3B,IAAI,CAAC,CAAC,CAAC,EAAE;YACR,kCAAkC;YAClC,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,QAAQ,EAAE,qCAAqC,oCAAM,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;YAC/G,IAAI,KAAK,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC;gBAChC,KAAK,EAAE,SAAS;gBAChB,QAAQ,EAAE,sBAAsB;gBAChC,OAAO,EAAE,CAAC;wBACR,IAAI,EAAE,IAAI;wBACV,OAAO,EAAE,CAAC,CAAC,EAAE;4BACX,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC,CAAC,wCAAwC;wBAC5E,CAAC;qBACF,CAAC;aACH,CAAC,CAAC;YACH,KAAK,CAAC,OAAO,EAAE,CAAC;QAClB,CAAC,CAAC;aACD,KAAK,CAAC,KAAK,CAAC,EAAE,CAAC,OAAO,CAAC,GAAG,CAAC,kBAAkB,EAAE,KAAK,CAAC,CAAC,CAAC;IAC5D,CAAC;IAED,QAAQ,CAAC,SAAmB;QAE1B,uEAAuE;QACvE,MAAM,OAAO,GAAG,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC;YACtC,OAAO,EAAE,eAAe;SACzB,CAAC,CAAC;QACH,OAAO,CAAC,OAAO,EAAE,CAAC;QAElB,kDAAkD;QAClD,EAAE,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;YACd,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC,4BAA4B;QAC9E,CAAC;QAAC,IAAI,CAAC,CAAC;YACN,4EAA4E;YAC5E,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;YACtB,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,QAAQ,EAAE,CAAC;QAC7C,CAAC;QAED,+CAA+C;QAC/C,IAAI,CAAC,SAAS;aACX,IAAI,CAAC,SAAS,CAAC,EAAE;YAChB,oBAAoB;YACpB,sEAAsE;YACtE,+CAA+C;YAC/C,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,SAAS,CAAC,YAAY,EAAE,CAAC;YAElD,qEAAqE;YACrE,SAAS,CAAC,OAAO,CAAC,CAAC,QAAQ,EAAE,KAAK,EAAE,EAAE;gBACpC,IAAI,CAAC,iBAAiB,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;YAC1C,CAAC,CAAC,CAAC;YAEH,sDAAsD;YACtD,OAAO,CAAC,OAAO,EAAE,CAAC;QACpB,CAAC,CAAC,CAAC;IAEP,CAAC;IAED,YAAY;QAEV,MAAM,OAAO,GAAG,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC;YACtC,OAAO,EAAE,eAAe;SACzB,CAAC,CAAC;QACH,OAAO,CAAC,OAAO,EAAE,CAAC;QAElB,kDAAkD;QAClD,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,YAAY,EAAE,CAAC;QAE/C,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE;YAE9B,oBAAoB;YACpB,sEAAsE;YACtE,+CAA+C;YAC/C,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,SAAS,CAAC,YAAY,EAAE,CAAC;YAClD,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,SAAS,EAAE,CAAC;YAE5C,qEAAqE;YACrE,SAAS,CAAC,OAAO,CAAC,CAAC,QAAQ,EAAE,KAAK,EAAE,EAAE;gBACpC,IAAI,CAAC,iBAAiB,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;YAC1C,CAAC,CAAC,CAAC;YAEH,sDAAsD;YACtD,OAAO,CAAC,OAAO,EAAE,CAAC;QACpB,CAAC,CAAC,CAAC;IACL,CAAC;IAED,iBAAiB,CAAC,QAAa,EAAE,KAAa;QAC5C,wCAAwC;QACxC,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;QACzC,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,EAAE;YAEtB,wDAAwD;YACxD,EAAE,CAAC,CAAC,OAAO,MAAM,KAAK,QAAQ,IAAI,MAAM,YAAY,MAAM,CAAC,CAAC,CAAC;gBAC3D,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,GAAG,KAAK,CAAC;gBAC3B,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,GAAG,MAAgB,CAAC;YACzC,CAAC;YAAC,IAAI,CAAC,CAAC;gBACN,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,GAAG,MAAM,CAAC;YAC9B,CAAC;YAED,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;YAC3C,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,EAAE;gBACtB,wDAAwD;gBACxD,EAAE,CAAC,CAAC,OAAO,MAAM,KAAK,QAAQ,IAAI,MAAM,YAAY,MAAM,CAAC,CAAC,CAAC;oBAC3D,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,GAAG,KAAK,CAAC;oBAC7B,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,GAAG,MAAgB,CAAC;gBACzC,CAAC;gBAAC,IAAI,CAAC,CAAC;oBACN,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,GAAG,MAAM,CAAC;gBAChC,CAAC;gBAED,IAAI,CAAC,cAAc,CAAC,KAAK,CAAC,GAAG,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,IAAI,UAAU,IAAI,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,IAAI,gBAAgB,CAAC;gBAC1G,OAAO,CAAC,GAAG,CAAC,oCAAM,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC,QAAQ,EAAE,EAAE,SAAS,EAAE,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,EAAE,WAAW,EAAE,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC;YACvH,CAAC,CAAC;QACJ,CAAC,CAAC;IACJ,CAAC;CAEF;AAhOY,gBAAgB;IAJ5B,wEAAS,CAAC;QACT,QAAQ,EAAE,oBAAoB;OACG;KAClC,CAAC;oKAW4B,CAA0C;QAChD,kKAAgC,CAAmB;QAC1D,4EAAW,EAAoB,sEAAe;QAC7C,gEAA8C;QAC/C,GAAG;AAkNnB;SAhOY,gBAAgB,gB","file":"2.js","sourcesContent":["import { NgModule } from '@angular/core';\nimport { IonicPageModule } from 'ionic-angular';\nimport { RefeicaoListPage } from './refeicao-list';\n\nimport { PipesModule } from '../../pipes/pipes.module';\n\n@NgModule({\n  declarations: [\n    RefeicaoListPage,\n  ],\n  imports: [\n    IonicPageModule.forChild(RefeicaoListPage),\n    PipesModule\n  ],\n  exports: [\n    RefeicaoListPage\n  ]\n})\nexport class RefeicaoListModule {}\n\n\n\n// WEBPACK FOOTER //\n// ./src/pages/refeicao-list/refeicao-list.module.ts","import { Component } from '@angular/core';\nimport { NavController, NavParams, LoadingController, Loading, AlertController } from 'ionic-angular';\n\nimport { AngularFireDatabase } from 'angularfire2/database';\n\nimport { Observable } from \"rxjs/Rx\";\n\n//moment.js library for handling timestamps\nimport * as moment from 'moment';\nimport 'moment/locale/pt-br';\n\nimport { TimeService } from '../../providers/time-service';\nimport { RefeicaoService } from '../../providers/refeicao-service';\nimport { UserService } from '../../providers/user-service';\n\nimport { FCM } from '@ionic-native/fcm';\n\nimport { IonicPage } from 'ionic-angular';\n@IonicPage()\n@Component({\n  selector: 'page-refeicao-list',\n  templateUrl: 'refeicao-list.html'\n})\nexport class RefeicaoListPage {\n\n  refeicoes: Promise<any>; //refeicoes array.\n  canGoForward: boolean;\n  canGoBack: boolean = false;\n  canBuy: Array<boolean> = [];\n  canQueue: Array<boolean> = [];\n  message: Array<string> = [];\n  boughtOrQueued: Array<boolean> = [];\n\n  constructor(public navCtrl: NavController, public navParams: NavParams,\n    public loadingCtrl: LoadingController, public afDB: AngularFireDatabase,\n    public time: TimeService, public _refeicao: RefeicaoService,\n    public _user: UserService, public alertCtrl: AlertController,\n    private fcm: FCM) {\n\n    //buscar a próxima página de refeições assim que a página carregar\n    this.nextPage(true);\n  }\n\n  /**\n   * Ir para a refeicao-detail page com a refeição escolhida.\n   * @param {any} refeicao A refeição escolhida\n   */\n  gotoDetails(refeicao: any): void {\n    this.navCtrl.push('RefeicaoDetailPage', {\n      refeicao: refeicao\n    })\n  }\n\n  /**\n   * Função pré book() que pergunta se o usuário confirma a reserva.\n   */\n  confirmBook(refeicao: any): void {\n    let confirm = this.alertCtrl.create({\n      title: 'Confirmar Reserva',\n      message: `Tem certeza que deseja reservar a refeicao de ${moment(refeicao.timestamp).format(`L`)}? Seu saldo será debitado.`,\n      buttons: [\n        {\n          text: 'Cancelar',\n        },\n        {\n          text: 'Sim',\n          handler: () => {\n            this.book(refeicao);\n          }\n        }\n      ]\n    });\n    confirm.present();\n  }\n\n  book(refeicao: any): void {\n    this._user.isVeg()\n      .then(snapshot => {\n        this._refeicao.book(refeicao, snapshot.val())\n          .then(_ => {\n            //TODO: Subscribe no tópico da refeição (FCM)\n            this.fcm.subscribeToTopic(refeicao.timestamp)\n            //Adicionar transação no histórico\n            this._user.addHistory('compra', `Refeição do dia ${moment(refeicao.timestamp).format('L')}`);\n            //Mostrar mensagem de confirmação.\n            //Não seria melhor um toast?\n            let alert = this.alertCtrl.create({ //AlertController para a compra realizada com sucesso.\n              title: 'Sucesso',\n              subTitle: 'Compra realizada com sucesso!',\n              buttons: [{\n                text: 'OK',\n                handler: _ => {\n                  this.navCtrl.setRoot('HomePage'); //redirecionar o usuário para a HomePage\n                }\n              }]\n            });\n            alert.present();\n          })\n          .catch(reason => {\n            let alert = this.alertCtrl.create({\n              title: 'Erro',\n              subTitle: reason.message,\n              buttons: ['OK']\n            })\n            alert.present();\n          });\n      })\n  }\n\n  /**\n   * Função pré queue() que confirma a entrada do usuário na fila de espera.\n   */\n  confirmQueue(refeicao: any): void {\n    let confirm = this.alertCtrl.create({\n      title: 'Confirmar entrada na fila',\n      message: `Tem certeza que deseja entrar na fila da refeição do dia ${moment(refeicao.timestamp).format(`L`)}? Seu saldo será debitado e te avisaremos caso você consiga uma vaga. Se não conseguir, seu saldo será reembolsado.`,\n      buttons: [\n        {\n          text: 'Cancelar',\n        },\n        {\n          text: 'Sim',\n          handler: () => {\n            this.queue(refeicao);\n          }\n        }\n      ]\n    });\n    confirm.present();\n  }\n\n  /**\n   * Coloca o usuário na fila de espera.\n   */\n  queue(refeicao: any): void {\n    this._refeicao.queue(refeicao)\n      .then(_ => {\n        //Adicionar transação no histórico\n        this._user.addHistory('compra', `Entrou na fila da refeição do dia ${moment(refeicao.timestamp).format('L')}`);\n        let alert = this.alertCtrl.create({ //AlertController para a compra realizada com sucesso.\n          title: 'Sucesso',\n          subTitle: 'Você entrou na fila!',\n          buttons: [{\n            text: 'OK',\n            handler: _ => {\n              this.navCtrl.setRoot('HomePage'); //redirecionar o usuário para a HomePage\n            }\n          }]\n        });\n        alert.present();\n      })\n      .catch(error => console.log('error in queue()', error));\n  }\n\n  nextPage(firstPage?: boolean): void {\n\n    //LoadingContoller para mostrar uma mensagem enquanto carrega os dados.\n    const loading = this.loadingCtrl.create({\n      content: 'Carregando...'\n    });\n    loading.present();\n\n    //Pegar a lista de refeições de maneira assíncrona\n    if (firstPage) {\n      this.refeicoes = this._refeicao.nextPage(true); //true para a flag firstPage\n    } else {\n      //Se não for a primeira página, o usuário pode voltar para a página anterior\n      this.canGoBack = true;\n      this.refeicoes = this._refeicao.nextPage();\n    }\n\n    //Verificar a resposta da Promise do nextPage()\n    this.refeicoes\n      .then(snapshots => {\n        //Atualizar as flags\n        //Isso é realizado aqui porque só temos certeza que todas as operações\n        //assíncronas foram realizadas no bloco then().\n        this.canGoForward = this._refeicao.canGoForward();\n\n        //para cada refeicao, verificar se pode comprar e pode entrar na fila\n        snapshots.forEach((snapshot, index) => {\n          this.checkAvailability(snapshot, index);\n        });\n\n        //Dismiss no LoadingController após tudo ser carregado\n        loading.dismiss();\n      });\n\n  }\n\n  previousPage(): void {\n\n    const loading = this.loadingCtrl.create({\n      content: 'Carregando...'\n    });\n    loading.present();\n\n    //Pegar a lista de refeições de maneira assíncrona\n    this.refeicoes = this._refeicao.previousPage();\n\n    this.refeicoes.then(snapshots => {\n\n      //Atualizar as flags\n      //Isso é realizado aqui porque só temos certeza que todas as operações\n      //assíncronas foram realizadas no bloco then().\n      this.canGoForward = this._refeicao.canGoForward();\n      this.canGoBack = this._refeicao.canGoBack();\n\n      //para cada refeicao, verificar se pode comprar e pode entrar na fila\n      snapshots.forEach((snapshot, index) => {\n        this.checkAvailability(snapshot, index);\n      });\n\n      //Dismiss no LoadingController após tudo ser carregado\n      loading.dismiss();\n    });\n  }\n\n  checkAvailability(snapshot: any, index: number) {\n    //iniciar as variaveis canBuy e canQueue\n    const obs1 = this._user.canBuy(snapshot);\n    obs1.subscribe(result => {\n\n      //Se result for uma string, então ocorreu algum problema\n      if (typeof result === 'string' || result instanceof String) {\n        this.canBuy[index] = false;\n        this.message[index] = result as string;\n      } else {\n        this.canBuy[index] = result;\n      }\n\n      const obs2 = this._user.canQueue(snapshot);\n      obs2.subscribe(result => {\n        //Se result for uma string, então ocorreu algum problema\n        if (typeof result === 'string' || result instanceof String) {\n          this.canQueue[index] = false;\n          this.message[index] = result as string;\n        } else {\n          this.canQueue[index] = result;\n        }\n\n        this.boughtOrQueued[index] = this.message[index] == 'Comprado' || this.message[index] == 'Entrou na fila';\n        console.log(moment(snapshot.timestamp).calendar(), 'canBuy?', this.canBuy[index], 'canQueue?', this.canQueue[index]);\n      })\n    })\n  }\n\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/pages/refeicao-list/refeicao-list.ts"],"sourceRoot":""}